---
title: 从零实现虚拟Camera Driver
toc: true
date: 2020-01-01 00:00:00
tags: V4L2
---

# 注册 Video Device

------

## 实现字符设备驱动的基本骨架

```c++
#include <linux/module.h>
#include <media/v4l2-device.h>

static int __init my_camera_init(void)
{
	int ret;
	return ret;
}

static void __exit my_camera_exit(void)
{

}

module_init(my_camera_init);
module_exit(my_camera_exit);
MODULE_LICENSE("GPL");
```



## 注册video device

- 分配一个 video_device结构体
- 配置注册video_device的必要条件
- 注册 video_device

```c
static struct video_device *my_camera_dev;
static struct v4l2_device v4l2_dev;

static const struct v4l2_file_operations my_camera_fops =
{
    .owner = THIS_MODULE,
};

static void my_camera_dev_release(struct video_device *vdev)
{
    
}

static int __init my_camera_init(void)
{
    int ret;
    /* 1.分配一个video_device结构体 */
    my_camera_dev = video_device_alloc();
    
    /* 2.设置 */
    my_camera_dev->release   = my_camera_dev_release;
    my_camera_dev->fops      = &my_camera_fops;
    my_camera_dev->v4l2_dev  = &v4l2_dev;
    
    /* 3.注册 */
    ret = video_register_device(my_camera_dev, VFL_TYPE_GRABBER, -1);
    return ret;
}
```

## 验证

```c
sudo modprobe vivid
sudo rmmod vivid
sudo insmod my_camera.ko
ls /dev/*video*
```

